image: docker:latest

services:
  - name: docker:dind
    command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]

variables:
  DOCKER_HOST: tcp://172.17.0.2:2375
  DOCKER_TLS_CERTDIR: ""

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - echo "Building the Docker image..."
    # Ensure Docker is available
    - docker info
    - docker build -t back-v1:${CI_COMMIT_SHA} .

deploy:
  stage: deploy
  script:
    - echo "Deploying the Docker image..."
    # Login to Docker registry
    - docker login -u mrmahdifardi -p 9gdU9jib42RjAGVxA1! registry.hamdocker.ir
    # Tag the built image for the registry
    - docker tag back-v1:${CI_COMMIT_SHA} registry.hamdocker.ir/mrmahdifardi/myapp:latest
    # Push the image to the Docker registry
    - docker push registry.hamdocker.ir/mrmahdifardi/myapp:latest
